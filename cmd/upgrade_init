#!/bin/bash

### This script is called before the user upgrades the application.

export PATH=/var/apps/nodejs_v22/target/bin:$PATH

DEFAULT_API_DIR="${TRIM_APPDEST}/api"
LOG_FILE="${TRIM_PKGVAR:-/tmp}/upgrade_init.log"

log() {
    echo "$1"
    mkdir -p "$(dirname "${LOG_FILE}")" >/dev/null 2>&1 || true
    echo "$(date '+%F %T') $1" >> "${LOG_FILE}" 2>/dev/null || true
}

resolve_api_dir() {
    if [ -d "${DEFAULT_API_DIR}" ]; then
        echo "${DEFAULT_API_DIR}"
        return 0
    fi
    local script_root
    script_root="$(cd "$(dirname "$0")/.." >/dev/null 2>&1 && pwd -P)"
    if [ -n "${script_root}" ] && [ -d "${script_root}/api" ]; then
        echo "${script_root}/api"
        return 0
    fi
    return 1
}

API_DIR="$(resolve_api_dir)" || {
    log "找不到 API 目录 (${DEFAULT_API_DIR})，已跳过 npm 安装。"
    exit 0
}

NODE_MODULES_DIR="${API_DIR}/node_modules"

install_deps() {
    cd "${API_DIR}"
    if command -v npm >/dev/null 2>&1; then
        if npm ci --omit=dev; then
            return 0
        else
            log "npm ci 失败，尝试 npm install --production ..."
            npm install --production
            return 0
        fi
    else
        log "未找到 npm，可执行文件，跳过安装。"
        return 1
    fi
}

if [ ! -d "${NODE_MODULES_DIR}" ] || [ ! -d "${NODE_MODULES_DIR}/axios" ] || [ ! -d "${NODE_MODULES_DIR}/xml2js" ]; then
    log "检测到 npm 依赖缺失/不完整，正在安装..."
    rm -rf "${NODE_MODULES_DIR}"
    install_deps || log "npm 依赖安装未完成，请手动检查。"
else
    log "npm 依赖已存在。"
fi

exit 0

name: Auto Build 2FMusic (Binary)

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-build:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # 1. ä» manifest æå–ç‰ˆæœ¬å·
    - name: Extract Version from Manifest
      id: version
      run: |
        # æŸ¥æ‰¾ä»¥ version å¼€å¤´çš„è¡Œï¼Œä»¥ = åˆ†å‰²ï¼Œæ‰“å°ç¬¬äºŒéƒ¨åˆ†ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
        VERSION=$(grep "^version" manifest | awk -F'=' '{print $2}' | xargs)
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "ğŸ¯ Detected version: ${VERSION}"

    # 2. è®¾ç½® Python ç¯å¢ƒ
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    # 3. å®‰è£…ä¾èµ– (PyInstaller å’Œ é¡¹ç›®ä¾èµ–)
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        # å®‰è£…é¡¹ç›®è¿è¡Œæ‰€éœ€çš„ä¾èµ–ï¼Œä»¥ä¾¿ PyInstaller èƒ½æ‰“åŒ…å®ƒä»¬
        if [ -f app/server/requirements.txt ]; then pip install -r app/server/requirements.txt; fi

    # 4. ç¼–è¯‘äºŒè¿›åˆ¶å¹¶æ¸…ç†
    - name: Compile and Cleanup
      run: |
        echo "ğŸ”¨ Compiling app.py..."
        # ç¼–è¯‘ä¸ºå•æ–‡ä»¶ï¼Œè¾“å‡ºåˆ° app/server/app
        pyinstaller --clean --onefile --name "app" --distpath "app/server" "app/server/app.py"
        
        # èµ‹äºˆæ‰§è¡Œæƒé™
        chmod +x app/server/app
        
        echo "ğŸ§¹ Cleaning up..."
        # æ¸…ç†ç¼–è¯‘ä¸´æ—¶æ–‡ä»¶
        rm -rf build/
        rm -f app.spec
        
        # åˆ é™¤æºç å’Œä¸å†éœ€è¦çš„ä¾èµ–åº“æ–‡ä»¶å¤¹
        rm -f app/server/app.py
        rm -rf app/server/lib
        
        echo "âœ… Compilation and cleanup complete."

    # 5. å®‰è£… fnpack
    - name: Install fnpack
      run: |
        wget https://static2.fnnas.com/fnpack/fnpack-1.0.4-linux-amd64 -O fnpack
        chmod +x fnpack
        sudo mv fnpack /usr/local/bin/

    # 6. æ„å»º fpk åŒ…
    - name: Build fpk package
      id: build
      run: |
        fnpack build
        FPK_FILE=$(ls *.fpk | head -n 1)
        echo "fpk_file=${FPK_FILE}" >> $GITHUB_OUTPUT
        echo "ğŸ“¦ FPK package built: ${FPK_FILE}"

    # 7. åˆ é™¤æ—§çš„åŒç‰ˆæœ¬ Pre-release
    - name: Delete old pre-releases
      run: |
        TAG="v${{ steps.version.outputs.version }}-pre"
        echo "Checking for old release with tag: $TAG"
        gh release delete "$TAG" --yes || true
        git push --delete origin "$TAG" || true
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # 8. åˆ›å»º Pre-release
    - name: Create Pre-release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}-pre
        name: 2FMusic ${{ steps.version.outputs.version }} (Binary Pre-release)
        body: |
          ## ğŸš€ Auto-built Binary Release

          **Version**: ${{ steps.version.outputs.version }}
          
          æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»º

        files: ${{ steps.build.outputs.fpk_file }}
        prerelease: true
        draft: false

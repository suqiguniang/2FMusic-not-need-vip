# 全栈重构计划

## 目标

- **前端**: 将现有基于原生 JavaScript/jQuery 的前端重构为现代化的 **Vite + Vue 3 + TypeScript + Pinia** 技术栈
- **后端**: 将庞大的单文件 `app.py` 重构为模块化的 Flask 应用结构,提高可维护性和扩展性

---

## Part I: 后端重构 (Python/Flask)

### 1. 目录结构规划

将 `server/app.py` 拆解为模块化结构:

```
server/
├── __init__.py           # App 工厂函数, 初始化 Flask, DB, Logging
├── config.py             # 配置加载
├── models/               # 数据模型与数据库操作
│   ├── __init__.py
│   ├── db.py             # SQLite 连接管理
│   └── song.py           # Song 相关操作
├── services/             # 业务逻辑
│   ├── scanner.py        # 音乐库扫描与监听 (Watchdog)
│   ├── metadata.py       # mutagen 元数据读写
│   └── downloader.py     # 网易云下载任务管理
├── routes/               # API 路由 (Blueprints)
│   ├── __init__.py
│   ├── music.py          # /api/music/*
│   ├── system.py         # /api/system/*
│   ├── netease.py        # /api/netease/*
│   ├── check.py          # /api/version_check, /api/auth
│   └── favorites.py      # /api/favorites/*
├── utils/                # 工具函数
│   ├── common.py
│   └── hasher.py
├── run.py                # 新的入口文件 (替代 app.py)
└── requirements.txt
```

### 2. 重构步骤

1. **创建基础结构**: 建立新的文件夹结构
2. **配置分离**: 将 `sys.argv` 解析和 `os.environ` 读取移动到 `app/config.py`
3. **数据库层提取**: 将 `init_db`、`get_db` 和 SQL 操作封装到 `app/models/`
4. **服务层提取**:
   - 将 `MusicFileEventHandler`、`init_watchdog`、`scan_library_incremental` 移至 `app/services/scanner.py`
   - 将 `get_metadata`、`extract_embedded_cover` 等移至 `app/services/metadata.py`
5. **路由拆分**: 将 `@app.route` 定义按功能分组迁移到 Blueprints 中
6. **入口点迁移**: 创建 `run.py` 作为新的启动脚本,保持与原 `app.py` 相同的命令行参数兼容性

---

## Part II: 前端重构 (Vue3 + TS)

### 1. 技术栈选择

- **构建工具**: Vite
- **框架**: Vue 3 (Composition API, `<script setup>`)
- **语言**: TypeScript
- **状态管理**: Pinia
- **路由**: Vue Router
- **UI 框架**: TailwindCSS (定制化设计)
- **HTTP 客户端**: Axios / Fetch Wrapper

### 2. 目录结构规划

```
frontend/
├── src/
│   ├── api/          # 接口层 (对应后端 Routes)
│   ├── components/   # UI 组件
│   ├── views/        # 页面视图
│   ├── stores/       # Pinia 状态
│   ├── router/       # 路由定义
│   ├── styles/       # 全局样式 (Tailwind directives)
│   ├── App.vue
│   └── main.ts
├── vite.config.ts    # 配置 Proxy 转发到后端
└── index.html
```

### 3. 分步实施计划

1. **项目初始化**: 创建 `frontend` 目录,安装依赖
2. **代理配置**: 设置 Vite Proxy 指向 `http://localhost:23237` (或后端运行的端口)
3. **核心模块迁移**:
   - **API 层**: 复刻 `api.js` 为 TypeScript 强类型接口
   - **状态管理**: 实现 `usePlayerStore`、`usePlaylistStore`
   - **播放器组件**: 实现核心播放、进度控制、歌词同步显示
4. **页面开发**:
   - Music Library (主页)
   - Lyrics View (歌词页)
   - Settings (设置页)
5. **样式复刻与升级**: 使用 TailwindCSS 重现现有 UI 风格并进行现代化微调

---

## 验证与发布

1. **API 测试**: 确保后端重构后,API 行为与原版一致 (Postman 或测试脚本)
2. **前端联调**: 新前端对接重构后的后端
3. **构建部署**:
   - 前端 `npm run build` → `www/static` & `www/templates`